<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网络可视化工具</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e6e6e6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            text-align: center;
            padding: 25px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #4cc9f0, #4361ee);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            color: #b8b8b8;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
            gap: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }

        .sidebar {
            flex: 1;
            min-width: 300px;
            background: rgba(30, 30, 46, 0.8);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
        }

        .main-content {
            flex: 3;
            min-width: 500px;
            background: rgba(30, 30, 46, 0.8);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
        }

        .panel-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4361ee;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #f8f9fa;
        }

        .panel-title i {
            color: #4cc9f0;
        }

        .control-group {
            margin-bottom: 25px;
        }

        .control-group h3 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #b8b8b8;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            background: rgba(67, 97, 238, 0.2);
            color: #e6e6e6;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1rem;
            border: 1px solid rgba(67, 97, 238, 0.3);
        }

        .btn:hover {
            background: rgba(67, 97, 238, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn i {
            font-size: 1.2rem;
        }

        .btn-danger {
            background: rgba(220, 53, 69, 0.2);
            border-color: rgba(220, 53, 69, 0.3);
        }

        .btn-danger:hover {
            background: rgba(220, 53, 69, 0.4);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.2);
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .color-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.2s;
        }

        .color-btn:hover {
            transform: scale(1.1);
            border-color: white;
        }

        .color-btn.active {
            border-color: white;
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.95rem;
            color: #b8b8b8;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.3);
            color: #e6e6e6;
            font-size: 1rem;
            transition: border 0.3s;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #4361ee;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .slider-container input {
            flex: 1;
        }

        .slider-value {
            min-width: 40px;
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
        }

        .network-canvas {
            flex: 1;
            min-height: 600px;
            position: relative;
            overflow: hidden;
        }

        #network-graph {
            width: 100%;
            height: 100%;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            background: rgba(20, 20, 35, 0.8);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .toolbar-left, .toolbar-right {
            display: flex;
            gap: 15px;
        }

        .export-btn {
            background: linear-gradient(90deg, #4361ee, #3a0ca3);
        }

        .export-btn:hover {
            background: linear-gradient(90deg, #3a0ca3, #4361ee);
        }

        .status-bar {
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .node-info-panel {
            margin-top: 25px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border-left: 4px solid #4cc9f0;
        }

        .node-info-panel h4 {
            margin-bottom: 10px;
            color: #4cc9f0;
        }

        .node-info-content {
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .node-info-content div {
            margin-bottom: 8px;
        }

        .sample-networks {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .sample-btn {
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .sample-btn:hover {
            background: rgba(67, 97, 238, 0.3);
        }

        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar, .main-content {
                min-width: 100%;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="header">
        <h1>网络可视化工具</h1>
        <p>交互式网络图编辑器，支持动态节点和边创建，自定义样式，力导向布局和数据分析</p>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="control-group">
                <h2 class="panel-title"><i class="fas fa-network-wired"></i> 网络控制</h2>
                
                <div class="btn-group">
                    <button class="btn" id="add-node-btn">
                        <i class="fas fa-plus-circle"></i> 添加节点
                    </button>
                    <button class="btn" id="add-edge-btn">
                        <i class="fas fa-link"></i> 添加连接
                    </button>
                    <button class="btn" id="delete-mode-btn">
                        <i class="fas fa-trash"></i> 删除模式
                    </button>
                    <button class="btn" id="clear-network-btn">
                        <i class="fas fa-broom"></i> 清空网络
                    </button>
                </div>
            </div>

            <div class="control-group">
                <h3><i class="fas fa-sliders-h"></i> 网络布局设置</h3>
                <div class="input-group">
                    <label>布局强度</label>
                    <div class="slider-container">
                        <input type="range" id="force-strength" min="1" max="100" value="50">
                        <span class="slider-value" id="force-strength-value">50</span>
                    </div>
                </div>
                <div class="input-group">
                    <label>连接距离</label>
                    <div class="slider-container">
                        <input type="range" id="link-distance" min="10" max="300" value="100">
                        <span class="slider-value" id="link-distance-value">100</span>
                    </div>
                </div>
                <div class="input-group">
                    <label>布局算法</label>
                    <select id="layout-algorithm">
                        <option value="force">力导向布局</option>
                        <option value="radial">径向布局</option>
                        <option value="circular">圆形布局</option>
                        <option value="grid">网格布局</option>
                    </select>
                </div>
            </div>

            <div class="control-group">
                <h3><i class="fas fa-palette"></i> 节点样式</h3>
                <div class="input-group">
                    <label>节点大小</label>
                    <div class="slider-container">
                        <input type="range" id="node-size" min="5" max="50" value="20">
                        <span class="slider-value" id="node-size-value">20</span>
                    </div>
                </div>
                <label>节点颜色</label>
                <div class="color-palette">
                    <div class="color-btn active" style="background-color: #4cc9f0;" data-color="#4cc9f0"></div>
                    <div class="color-btn" style="background-color: #4361ee;" data-color="#4361ee"></div>
                    <div class="color-btn" style="background-color: #7209b7;" data-color="#7209b7"></div>
                    <div class="color-btn" style="background-color: #f72585;" data-color="#f72585"></div>
                    <div class="color-btn" style="background-color: #2ecc71;" data-color="#2ecc71"></div>
                    <div class="color-btn" style="background-color: #f1c40f;" data-color="#f1c40f"></div>
                    <div class="color-btn" style="background-color: #e74c3c;" data-color="#e74c3c"></div>
                    <div class="color-btn" style="background-color: #95a5a6;" data-color="#95a5a6"></div>
                </div>
            </div>

            <div class="control-group">
                <h3><i class="fas fa-project-diagram"></i> 示例网络</h3>
                <div class="sample-networks">
                    <div class="sample-btn" id="sample-star">星型网络</div>
                    <div class="sample-btn" id="sample-mesh">网状网络</div>
                    <div class="sample-btn" id="sample-tree">树状网络</div>
                    <div class="sample-btn" id="sample-ring">环状网络</div>
                </div>
            </div>

            <div class="node-info-panel" id="node-info">
                <h4><i class="fas fa-info-circle"></i> 节点信息</h4>
                <div class="node-info-content">
                    <div>点击网络中的节点查看详细信息</div>
                </div>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #4cc9f0;"></div>
                    <span>普通节点</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #f72585;"></div>
                    <span>中心节点</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #2ecc71;"></div>
                    <span>连接节点</span>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="network-canvas">
                <svg id="network-graph" width="100%" height="100%"></svg>
            </div>
            
            <div class="toolbar">
                <div class="toolbar-left">
                    <button class="btn" id="run-layout-btn">
                        <i class="fas fa-play"></i> 运行布局
                    </button>
                    <button class="btn" id="pause-layout-btn">
                        <i class="fas fa-pause"></i> 暂停布局
                    </button>
                    <button class="btn" id="reset-layout-btn">
                        <i class="fas fa-redo"></i> 重置布局
                    </button>
                </div>
                <div class="toolbar-right">
                    <button class="btn export-btn" id="export-btn">
                        <i class="fas fa-download"></i> 导出图像
                    </button>
                    <button class="btn" id="data-btn">
                        <i class="fas fa-database"></i> 网络数据
                    </button>
                </div>
            </div>
            
            <div class="status-bar">
                <div id="node-count">节点: 0</div>
                <div id="edge-count">连接: 0</div>
                <div id="selected-node">选中: 无</div>
            </div>
        </div>
    </div>

    <script>
        // 网络可视化工具主类
        class NetworkVisualizer {
            constructor() {
                this.nodes = [];
                this.links = [];
                this.selectedNode = null;
                this.deleteMode = false;
                this.simulation = null;
                this.nodeIdCounter = 0;
                this.linkIdCounter = 0;
                this.currentNodeColor = "#4cc9f0";
                this.currentNodeSize = 20;
                
                this.init();
                this.setupEventListeners();
                this.createSampleNetwork();
            }
            
            init() {
                // 设置 SVG 容器
                this.svg = d3.select("#network-graph");
                this.width = this.svg.node().getBoundingClientRect().width;
                this.height = this.svg.node().getBoundingClientRect().height;
                
                // 创建力导向模拟
                this.simulation = d3.forceSimulation(this.nodes)
                    .force("link", d3.forceLink(this.links).id(d => d.id).distance(100))
                    .force("charge", d3.forceManyBody().strength(-50))
                    .force("center", d3.forceCenter(this.width / 2, this.height / 2))
                    .force("collision", d3.forceCollide().radius(d => d.radius + 5))
                    .on("tick", () => this.ticked());
                
                // 创建 SVG 组
                this.linkGroup = this.svg.append("g").attr("class", "links");
                this.nodeGroup = this.svg.append("g").attr("class", "nodes");
                
                // 初始化拖拽行为
                this.drag = d3.drag()
                    .on("start", (event, d) => this.dragStarted(event, d))
                    .on("drag", (event, d) => this.dragged(event, d))
                    .on("end", (event, d) => this.dragEnded(event, d));
                
                this.updateGraph();
                this.updateCounters();
            }
            
            // 创建示例网络
            createSampleNetwork() {
                // 创建中心节点
                const centerNode = this.addNode(this.width / 2, this.height / 2, "中心节点", "#f72585", 25);
                
                // 创建一些外围节点
                for (let i = 0; i < 5; i++) {
                    const angle = (i / 5) * 2 * Math.PI;
                    const x = this.width / 2 + 150 * Math.cos(angle);
                    const y = this.height / 2 + 150 * Math.sin(angle);
                    const node = this.addNode(x, y, `节点 ${i + 1}`, "#4cc9f0", 20);
                    
                    // 连接到中心节点
                    this.addLink(centerNode.id, node.id);
                }
                
                // 添加一些额外的连接
                this.addLink(this.nodes[1].id, this.nodes[2].id);
                this.addLink(this.nodes[3].id, this.nodes[4].id);
                
                this.updateGraph();
            }
            
            // 添加节点
            addNode(x, y, label = null, color = null, radius = null) {
                const node = {
                    id: `node-${this.nodeIdCounter++}`,
                    x: x,
                    y: y,
                    radius: radius || this.currentNodeSize,
                    color: color || this.currentNodeColor,
                    label: label || `节点 ${this.nodeIdCounter}`,
                    connections: 0
                };
                
                this.nodes.push(node);
                this.updateCounters();
                return node;
            }
            
            // 添加连接
            addLink(sourceId, targetId) {
                // 检查连接是否已存在
                const existingLink = this.links.find(link => 
                    (link.source.id === sourceId && link.target.id === targetId) ||
                    (link.source.id === targetId && link.target.id === sourceId)
                );
                
                if (existingLink) return null;
                
                const sourceNode = this.nodes.find(n => n.id === sourceId);
                const targetNode = this.nodes.find(n => n.id === targetId);
                
                if (!sourceNode || !targetNode) return null;
                
                const link = {
                    id: `link-${this.linkIdCounter++}`,
                    source: sourceNode,
                    target: targetNode,
                    value: 1
                };
                
                this.links.push(link);
                sourceNode.connections++;
                targetNode.connections++;
                
                this.updateCounters();
                return link;
            }
            
            // 删除节点
            deleteNode(nodeId) {
                // 删除与该节点相关的所有连接
                this.links = this.links.filter(link => 
                    link.source.id !== nodeId && link.target.id !== nodeId
                );
                
                // 删除节点
                this.nodes = this.nodes.filter(node => node.id !== nodeId);
                
                this.selectedNode = null;
                this.updateGraph();
                this.updateCounters();
                this.updateNodeInfo(null);
            }
            
            // 删除连接
            deleteLink(sourceId, targetId) {
                const linkIndex = this.links.findIndex(link => 
                    (link.source.id === sourceId && link.target.id === targetId) ||
                    (link.source.id === targetId && link.target.id === sourceId)
                );
                
                if (linkIndex !== -1) {
                    const link = this.links[linkIndex];
                    
                    // 更新连接计数
                    link.source.connections--;
                    link.target.connections--;
                    
                    this.links.splice(linkIndex, 1);
                    this.updateGraph();
                    this.updateCounters();
                }
            }
            
            // 更新图形
            updateGraph() {
                // 更新连接
                const links = this.linkGroup.selectAll("line")
                    .data(this.links, d => d.id);
                
                links.enter()
                    .append("line")
                    .attr("class", "link")
                    .attr("stroke", "#5a6a8c")
                    .attr("stroke-width", 2)
                    .attr("stroke-opacity", 0.7)
                    .merge(links)
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);
                
                links.exit().remove();
                
                // 更新节点
                const nodes = this.nodeGroup.selectAll("g.node")
                    .data(this.nodes, d => d.id);
                
                const nodeEnter = nodes.enter()
                    .append("g")
                    .attr("class", "node")
                    .call(this.drag)
                    .on("click", (event, d) => this.nodeClicked(event, d))
                    .on("mouseover", (event, d) => this.nodeMouseOver(event, d))
                    .on("mouseout", (event, d) => this.nodeMouseOut(event, d));
                
                // 添加节点圆形
                nodeEnter.append("circle")
                    .attr("r", d => d.radius)
                    .attr("fill", d => d.color)
                    .attr("stroke", "#fff")
                    .attr("stroke-width", 2);
                
                // 添加节点标签
                nodeEnter.append("text")
                    .attr("class", "node-label")
                    .attr("text-anchor", "middle")
                    .attr("dy", ".35em")
                    .attr("fill", "#fff")
                    .attr("font-size", "12px")
                    .attr("font-weight", "bold")
                    .text(d => d.label);
                
                // 更新现有节点
                const nodeUpdate = nodes.merge(nodeEnter);
                
                nodeUpdate.select("circle")
                    .attr("r", d => d.radius)
                    .attr("fill", d => d.color)
                    .attr("stroke", d => d.id === (this.selectedNode?.id) ? "#fff" : "rgba(255,255,255,0.5)")
                    .attr("stroke-width", d => d.id === (this.selectedNode?.id) ? 3 : 2);
                
                nodeUpdate.select(".node-label")
                    .text(d => d.label);
                
                nodes.exit().remove();
                
                // 更新模拟
                this.simulation.nodes(this.nodes);
                this.simulation.force("link").links(this.links);
                this.simulation.alpha(0.3).restart();
            }
            
            // 模拟 tick 事件
            ticked() {
                this.linkGroup.selectAll("line")
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);
                
                this.nodeGroup.selectAll("g.node")
                    .attr("transform", d => `translate(${d.x},${d.y})`);
            }
            
            // 拖拽事件
            dragStarted(event, d) {
                if (!event.active) this.simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }
            
            dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }
            
            dragEnded(event, d) {
                if (!event.active) this.simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
            
            // 节点点击事件
            nodeClicked(event, d) {
                event.stopPropagation();
                
                if (this.deleteMode) {
                    this.deleteNode(d.id);
                    return;
                }
                
                this.selectedNode = d;
                this.updateNodeInfo(d);
                this.updateGraph();
                this.updateCounters();
            }
            
            // 节点鼠标悬停事件
            nodeMouseOver(event, d) {
                // 高亮相关节点和连接
                this.linkGroup.selectAll("line")
                    .attr("stroke-opacity", link => 
                        (link.source.id === d.id || link.target.id === d.id) ? 1 : 0.2
                    );
                
                this.nodeGroup.selectAll("g.node")
                    .select("circle")
                    .attr("opacity", node => 
                        node.id === d.id || 
                        this.links.some(link => 
                            (link.source.id === d.id && link.target.id === node.id) ||
                            (link.target.id === d.id && link.source.id === node.id)
                        ) ? 1 : 0.4
                    );
            }
            
            // 节点鼠标移出事件
            nodeMouseOut(event, d) {
                // 恢复所有元素
                this.linkGroup.selectAll("line")
                    .attr("stroke-opacity", 0.7);
                
                this.nodeGroup.selectAll("g.node")
                    .select("circle")
                    .attr("opacity", 1);
            }
            
            // 更新节点信息面板
            updateNodeInfo(node) {
                const infoPanel = document.getElementById("node-info");
                const contentDiv = infoPanel.querySelector(".node-info-content");
                
                if (!node) {
                    contentDiv.innerHTML = "<div>点击网络中的节点查看详细信息</div>";
                    document.getElementById("selected-node").textContent = "选中: 无";
                    return;
                }
                
                contentDiv.innerHTML = `
                    <div><strong>ID:</strong> ${node.id}</div>
                    <div><strong>标签:</strong> ${node.label}</div>
                    <div><strong>连接数:</strong> ${node.connections}</div>
                    <div><strong>颜色:</strong> <span style="color:${node.color}">${node.color}</span></div>
                    <div><strong>大小:</strong> ${node.radius}px</div>
                    <div><strong>位置:</strong> (${Math.round(node.x)}, ${Math.round(node.y)})</div>
                `;
                
                document.getElementById("selected-node").textContent = `选中: ${node.label}`;
            }
            
            // 更新计数器
            updateCounters() {
                document.getElementById("node-count").textContent = `节点: ${this.nodes.length}`;
                document.getElementById("edge-count").textContent = `连接: ${this.links.length}`;
            }
            
            // 清空网络
            clearNetwork() {
                this.nodes = [];
                this.links = [];
                this.selectedNode = null;
                this.nodeIdCounter = 0;
                this.linkIdCounter = 0;
                this.updateGraph();
                this.updateCounters();
                this.updateNodeInfo(null);
            }
            
            // 更改布局算法
            changeLayout(algorithm) {
                // 重置所有力
                this.simulation.force("charge", null);
                this.simulation.force("center", null);
                this.simulation.force("collision", null);
                
                switch(algorithm) {
                    case "force":
                        this.simulation
                            .force("charge", d3.forceManyBody().strength(-50))
                            .force("center", d3.forceCenter(this.width / 2, this.height / 2))
                            .force("collision", d3.forceCollide().radius(d => d.radius + 5));
                        break;
                    case "radial":
                        const centerNode = this.nodes[0] || {x: this.width/2, y: this.height/2};
                        this.simulation
                            .force("charge", d3.forceManyBody().strength(-100))
                            .force("radial", d3.forceRadial(200, centerNode.x, centerNode.y))
                            .force("collision", d3.forceCollide().radius(d => d.radius + 10));
                        break;
                    case "circular":
                        this.simulation
                            .force("charge", d3.forceManyBody().strength(-30))
                            .force("center", d3.forceCenter(this.width / 2, this.height / 2))
                            .force("circular", d3.forceRadial(200, this.width/2, this.height/2).strength(0.1))
                            .force("collision", d3.forceCollide().radius(d => d.radius + 15));
                        break;
                    case "grid":
                        this.simulation
                            .force("charge", d3.forceManyBody().strength(0))
                            .force("center", d3.forceCenter(this.width / 2, this.height / 2))
                            .force("x", d3.forceX(this.width/2).strength(0.1))
                            .force("y", d3.forceY(this.height/2).strength(0.1))
                            .force("collision", d3.forceCollide().radius(d => d.radius + 20));
                        break;
                }
                
                this.simulation.alpha(0.5).restart();
            }
            
            // 设置事件监听器
            setupEventListeners() {
                // 添加节点按钮
                document.getElementById("add-node-btn").addEventListener("click", () => {
                    const x = Math.random() * (this.width - 100) + 50;
                    const y = Math.random() * (this.height - 100) + 50;
                    this.addNode(x, y);
                    this.updateGraph();
                });
                
                // 添加连接按钮
                document.getElementById("add-edge-btn").addEventListener("click", () => {
                    if (this.nodes.length < 2) {
                        alert("需要至少两个节点才能创建连接");
                        return;
                    }
                    
                    // 随机选择两个不同的节点
                    const node1 = this.nodes[Math.floor(Math.random() * this.nodes.length)];
                    let node2;
                    do {
                        node2 = this.nodes[Math.floor(Math.random() * this.nodes.length)];
                    } while (node1.id === node2.id);
                    
                    this.addLink(node1.id, node2.id);
                    this.updateGraph();
                });
                
                // 删除模式按钮
                document.getElementById("delete-mode-btn").addEventListener("click", () => {
                    this.deleteMode = !this.deleteMode;
                    const btn = document.getElementById("delete-mode-btn");
                    
                    if (this.deleteMode) {
                        btn.innerHTML = '<i class="fas fa-times"></i> 取消删除模式';
                        btn.classList.add("btn-danger");
                    } else {
                        btn.innerHTML = '<i class="fas fa-trash"></i> 删除模式';
                        btn.classList.remove("btn-danger");
                    }
                });
                
                // 清空网络按钮
                document.getElementById("clear-network-btn").addEventListener("click", () => {
                    if (confirm("确定要清空整个网络吗？")) {
                        this.clearNetwork();
                    }
                });
                
                // 运行布局按钮
                document.getElementById("run-layout-btn").addEventListener("click", () => {
                    this.simulation.alpha(0.5).restart();
                });
                
                // 暂停布局按钮
                document.getElementById("pause-layout-btn").addEventListener("click", () => {
                    this.simulation.stop();
                });
                
                // 重置布局按钮
                document.getElementById("reset-layout-btn").addEventListener("click", () => {
                    this.nodes.forEach(node => {
                        node.fx = null;
                        node.fy = null;
                    });
                    this.simulation.alpha(0.5).restart();
                });
                
                // 导出按钮
                document.getElementById("export-btn").addEventListener("click", () => {
                    this.exportAsPNG();
                });
                
                // 网络数据按钮
                document.getElementById("data-btn").addEventListener("click", () => {
                    this.showNetworkData();
                });
                
                // 布局强度滑块
                document.getElementById("force-strength").addEventListener("input", (e) => {
                    const value = e.target.value;
                    document.getElementById("force-strength-value").textContent = value;
                    
                    // 调整电荷力强度
                    this.simulation.force("charge", d3.forceManyBody().strength(-value));
                    this.simulation.alpha(0.3).restart();
                });
                
                // 连接距离滑块
                document.getElementById("link-distance").addEventListener("input", (e) => {
                    const value = e.target.value;
                    document.getElementById("link-distance-value").textContent = value;
                    
                    // 调整连接距离
                    this.simulation.force("link").distance(parseInt(value));
                    this.simulation.alpha(0.3).restart();
                });
                
                // 节点大小滑块
                document.getElementById("node-size").addEventListener("input", (e) => {
                    const value = e.target.value;
                    this.currentNodeSize = parseInt(value);
                    document.getElementById("node-size-value").textContent = value;
                    
                    // 更新所有节点大小
                    this.nodes.forEach(node => {
                        if (node.id !== (this.selectedNode?.id)) {
                            node.radius = this.currentNodeSize;
                        }
                    });
                    
                    this.updateGraph();
                });
                
                // 布局算法选择
                document.getElementById("layout-algorithm").addEventListener("change", (e) => {
                    this.changeLayout(e.target.value);
                });
                
                // 颜色选择
                document.querySelectorAll(".color-btn").forEach(btn => {
                    btn.addEventListener("click", () => {
                        // 移除所有active类
                        document.querySelectorAll(".color-btn").forEach(b => b.classList.remove("active"));
                        // 添加active类到当前按钮
                        btn.classList.add("active");
                        
                        this.currentNodeColor = btn.dataset.color;
                        
                        // 更新选中节点的颜色
                        if (this.selectedNode) {
                            this.selectedNode.color = this.currentNodeColor;
                            this.updateGraph();
                        }
                    });
                });
                
                // 示例网络按钮
                document.getElementById("sample-star").addEventListener("click", () => {
                    this.clearNetwork();
                    
                    // 创建星型网络
                    const centerNode = this.addNode(this.width / 2, this.height / 2, "中心", "#f72585", 30);
                    
                    for (let i = 0; i < 8; i++) {
                        const angle = (i / 8) * 2 * Math.PI;
                        const x = this.width / 2 + 200 * Math.cos(angle);
                        const y = this.height / 2 + 200 * Math.sin(angle);
                        const node = this.addNode(x, y, `节点 ${i + 1}`, "#4cc9f0", 20);
                        
                        this.addLink(centerNode.id, node.id);
                    }
                    
                    this.updateGraph();
                });
                
                document.getElementById("sample-mesh").addEventListener("click", () => {
                    this.clearNetwork();
                    
                    // 创建网状网络
                    const nodes = [];
                    
                    // 创建节点网格
                    for (let i = 0; i < 5; i++) {
                        for (let j = 0; j < 5; j++) {
                            const x = 100 + j * 150;
                            const y = 100 + i * 150;
                            const node = this.addNode(x, y, `${i+1}-${j+1}`, "#2ecc71", 18);
                            nodes.push(node);
                        }
                    }
                    
                    // 创建连接（每个节点连接相邻节点）
                    for (let i = 0; i < nodes.length; i++) {
                        const row = Math.floor(i / 5);
                        const col = i % 5;
                        
                        // 连接右侧节点
                        if (col < 4) {
                            this.addLink(nodes[i].id, nodes[i + 1].id);
                        }
                        
                        // 连接下方节点
                        if (row < 4) {
                            this.addLink(nodes[i].id, nodes[i + 5].id);
                        }
                    }
                    
                    this.updateGraph();
                });
                
                document.getElementById("sample-tree").addEventListener("click", () => {
                    this.clearNetwork();
                    
                    // 创建树状网络
                    const rootNode = this.addNode(this.width / 2, 100, "根节点", "#f1c40f", 25);
                    
                    // 第一层子节点
                    const level1Nodes = [];
                    for (let i = 0; i < 3; i++) {
                        const x = this.width / 2 - 200 + i * 200;
                        const y = 250;
                        const node = this.addNode(x, y, `L1-${i+1}`, "#4cc9f0", 20);
                        level1Nodes.push(node);
                        this.addLink(rootNode.id, node.id);
                    }
                    
                    // 第二层子节点
                    for (let i = 0; i < level1Nodes.length; i++) {
                        for (let j = 0; j < 2; j++) {
                            const x = level1Nodes[i].x - 80 + j * 160;
                            const y = 400;
                            const node = this.addNode(x, y, `L2-${i+1}-${j+1}`, "#2ecc71", 18);
                            this.addLink(level1Nodes[i].id, node.id);
                        }
                    }
                    
                    this.updateGraph();
                });
                
                document.getElementById("sample-ring").addEventListener("click", () => {
                    this.clearNetwork();
                    
                    // 创建环状网络
                    const nodes = [];
                    const numNodes = 10;
                    
                    for (let i = 0; i < numNodes; i++) {
                        const angle = (i / numNodes) * 2 * Math.PI;
                        const x = this.width / 2 + 200 * Math.cos(angle);
                        const y = this.height / 2 + 200 * Math.sin(angle);
                        const node = this.addNode(x, y, `节点 ${i + 1}`, "#7209b7", 20);
                        nodes.push(node);
                    }
                    
                    // 连接成环
                    for (let i = 0; i < numNodes; i++) {
                        this.addLink(nodes[i].id, nodes[(i + 1) % numNodes].id);
                    }
                    
                    // 添加一些额外的交叉连接
                    this.addLink(nodes[0].id, nodes[5].id);
                    this.addLink(nodes[2].id, nodes[7].id);
                    this.addLink(nodes[3].id, nodes[8].id);
                    
                    this.updateGraph();
                });
                
                // 点击SVG空白处取消选择
                this.svg.on("click", () => {
                    if (this.deleteMode) return;
                    
                    this.selectedNode = null;
                    this.updateNodeInfo(null);
                    this.updateGraph();
                });
                
                // 窗口大小调整
                window.addEventListener("resize", () => {
                    this.width = this.svg.node().getBoundingClientRect().width;
                    this.height = this.svg.node().getBoundingClientRect().height;
                    
                    this.simulation.force("center", d3.forceCenter(this.width / 2, this.height / 2));
                    this.simulation.alpha(0.3).restart();
                });
            }
            
            // 导出为PNG
            exportAsPNG() {
                const svgData = new XMLSerializer().serializeToString(this.svg.node());
                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");
                
                // 设置canvas尺寸
                canvas.width = this.width;
                canvas.height = this.height;
                
                // 创建图像并绘制到canvas
                const img = new Image();
                const svgBlob = new Blob([svgData], {type: "image/svg+xml;charset=utf-8"});
                const url = URL.createObjectURL(svgBlob);
                
                img.onload = () => {
                    ctx.fillStyle = "#1a1a2e";
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                    
                    // 创建下载链接
                    const png = canvas.toDataURL("image/png");
                    const a = document.createElement("a");
                    a.href = png;
                    a.download = "network-visualization.png";
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    URL.revokeObjectURL(url);
                };
                
                img.src = url;
            }
            
            // 显示网络数据
            showNetworkData() {
                const nodeData = this.nodes.map(node => ({
                    id: node.id,
                    label: node.label,
                    connections: node.connections,
                    color: node.color,
                    radius: node.radius,
                    x: Math.round(node.x),
                    y: Math.round(node.y)
                }));
                
                const linkData = this.links.map(link => ({
                    source: link.source.id,
                    target: link.target.id,
                    value: link.value
                }));
                
                const networkData = {
                    nodes: nodeData,
                    links: linkData,
                    totalNodes: this.nodes.length,
                    totalLinks: this.links.length,
                    density: this.nodes.length > 1 ? 
                        (2 * this.links.length) / (this.nodes.length * (this.nodes.length - 1)) : 0
                };
                
                const dataStr = JSON.stringify(networkData, null, 2);
                const dataWindow = window.open();
                dataWindow.document.write(`<pre>${dataStr}</pre>`);
                dataWindow.document.title = "网络数据";
                dataWindow.document.body.style.backgroundColor = "#1a1a2e";
                dataWindow.document.body.style.color = "#e6e6e6";
                dataWindow.document.body.style.padding = "20px";
                dataWindow.document.body.style.fontFamily = "monospace";
            }
        }
        
        // 初始化网络可视化工具
        document.addEventListener("DOMContentLoaded", () => {
            window.networkViz = new NetworkVisualizer();
        });
    </script>
</body>
</html>
