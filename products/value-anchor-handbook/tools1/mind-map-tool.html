<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>思维导图工具</title>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar/dist/mindar.prod.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .container {
            flex: 1;
            display: flex;
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }

        .sidebar {
            width: 280px;
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .workspace {
            flex: 1;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .tool-panel {
            margin-bottom: 30px;
        }

        .tool-panel h3 {
            color: #34495e;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        .tool-btn {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 10px;
            border: none;
            border-radius: 8px;
            background: #ecf0f1;
            color: #2c3e50;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tool-btn:hover {
            background: #3498db;
            color: white;
            transform: translateY(-2px);
        }

        .tool-btn i {
            font-size: 1.2em;
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .color-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid white;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        .color-btn:hover {
            transform: scale(1.1);
        }

        .mindmap-container {
            width: 100%;
            height: 100%;
            min-height: 700px;
            background: #f8f9fa;
            position: relative;
            overflow: auto;
        }

        .node {
            position: absolute;
            min-width: 120px;
            padding: 15px 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            cursor: move;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .node:hover {
            transform: scale(1.03);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        }

        .node.active {
            border-color: #3498db;
            z-index: 100;
        }

        .node-content {
            font-size: 14px;
            font-weight: 500;
            color: #2c3e50;
            outline: none;
            min-height: 20px;
        }

        .node-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .node:hover .node-actions {
            opacity: 1;
        }

        .node-btn {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            background: #ecf0f1;
            border: none;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .node-btn:hover {
            background: #3498db;
            color: white;
        }

        .connection {
            position: absolute;
            pointer-events: none;
            z-index: 1;
        }

        .connection-line {
            stroke: #95a5a6;
            stroke-width: 2;
            fill: none;
        }

        .export-panel {
            background: #2c3e50;
            padding: 20px;
            border-radius: 0 0 12px 12px;
        }

        .export-btn {
            width: 100%;
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .export-btn:hover {
            background: #2980b9;
        }

        .instructions {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .instructions h4 {
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .instructions ul {
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 5px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="header">
        <h1>思维导图工具</h1>
        <p>可视化您的想法，构建知识网络</p>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="tool-panel">
                <h3>节点操作</h3>
                <button class="tool-btn" id="addNode">
                    <i class="fas fa-plus-circle"></i>添加节点
                </button>
                <button class="tool-btn" id="addChild">
                    <i class="fas fa-level-down-alt"></i>添加子节点
                </button>
                <button class="tool-btn" id="deleteNode">
                    <i class="fas fa-trash"></i>删除节点
                </button>
                <button class="tool-btn" id="editNode">
                    <i class="fas fa-edit"></i>编辑节点
                </button>
            </div>

            <div class="tool-panel">
                <h3>样式设置</h3>
                <div class="color-palette">
                    <div class="color-btn" style="background:#e74c3c;" data-color="#e74c3c"></div>
                    <div class="color-btn" style="background:#3498db;" data-color="#3498db"></div>
                    <div class="color-btn" style="background:#2ecc71;" data-color="#2ecc71"></div>
                    <div class="color-btn" style="background:#f1c40f;" data-color="#f1c40f"></div>
                    <div class="color-btn" style="background:#9b59b6;" data-color="#9b59b6"></div>
                    <div class="color-btn" style="background:#1abc9c;" data-color="#1abc9c"></div>
                    <div class="color-btn" style="background:#e67e22;" data-color="#e67e22"></div>
                    <div class="color-btn" style="background:#34495e;" data-color="#34495e"></div>
                </div>
                <button class="tool-btn" id="changeColor">
                    <i class="fas fa-fill-drip"></i>应用颜色
                </button>
            </div>

            <div class="tool-panel">
                <h3>布局</h3>
                <button class="tool-btn" id="arrangeTree">
                    <i class="fas fa-project-diagram"></i>自动排列
                </button>
                <button class="tool-btn" id="resetView">
                    <i class="fas fa-expand-arrows-alt"></i>重置视图
                </button>
            </div>

            <div class="instructions">
                <h4>使用说明：</h4>
                <ul>
                    <li>点击节点进行选择</li>
                    <li>双击节点编辑内容</li>
                    <li>拖拽节点移动位置</li>
                    <li>使用右侧按钮添加/删除节点</li>
                    <li>连线自动生成和更新</li>
                </ul>
            </div>
        </div>

        <div class="workspace">
            <div class="mindmap-container" id="mindmap"></div>
            <div class="export-panel">
                <button class="export-btn" id="exportBtn">
                    <i class="fas fa-download"></i> 导出思维导图 (PNG)
                </button>
            </div>
        </div>
    </div>

    <script>
        class MindMap {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.nodes = [];
                this.connections = [];
                this.selectedNode = null;
                this.nodeIdCounter = 0;
                this.init();
            }

            init() {
                this.createRootNode();
                this.setupEventListeners();
                this.setupToolbarEvents();
            }

            createRootNode() {
                const rootNode = this.createNode({
                    id: this.nodeIdCounter++,
                    x: this.container.clientWidth / 2 - 100,
                    y: 100,
                    content: '中心主题',
                    color: '#3498db'
                });
                this.nodes.push(rootNode);
                this.selectNode(rootNode);
            }

            createNode(config) {
                const node = document.createElement('div');
                node.className = 'node';
                node.id = `node-${config.id}`;
                node.style.left = `${config.x}px`;
                node.style.top = `${config.y}px`;
                node.style.borderColor = config.color;
                node.dataset.id = config.id;

                node.innerHTML = `
                    <div class="node-actions">
                        <button class="node-btn add-child"><i class="fas fa-plus"></i></button>
                        <button class="node-btn delete"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="node-content" contenteditable="false">${config.content}</div>
                `;

                const contentDiv = node.querySelector('.node-content');
                const addChildBtn = node.querySelector('.add-child');
                const deleteBtn = node.querySelector('.delete');

                // 节点点击选择
                node.addEventListener('click', (e) => {
                    if (e.target === node || e.target === contentDiv) {
                        this.selectNode(node);
                    }
                });

                // 双击编辑
                contentDiv.addEventListener('dblclick', () => {
                    contentDiv.contentEditable = true;
                    contentDiv.focus();
                });

                contentDiv.addEventListener('blur', () => {
                    contentDiv.contentEditable = false;
                });

                contentDiv.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        contentDiv.blur();
                    }
                });

                // 添加子节点
                addChildBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.addChildNode(config.id);
                });

                // 删除节点
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.deleteNode(config.id);
                });

                // 拖拽功能
                this.makeDraggable(node);

                this.container.appendChild(node);
                return node;
            }

            makeDraggable(node) {
                let isDragging = false;
                let offsetX, offsetY;

                node.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('node-content') && 
                        node.querySelector('.node-content').contentEditable === 'true') {
                        return;
                    }

                    isDragging = true;
                    this.selectNode(node);
                    
                    const rect = node.getBoundingClientRect();
                    const containerRect = this.container.getBoundingClientRect();
                    
                    offsetX = e.clientX - rect.left + containerRect.left;
                    offsetY = e.clientY - rect.top + containerRect.top;
                    
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    
                    const containerRect = this.container.getBoundingClientRect();
                    const x = e.clientX - containerRect.left - offsetX;
                    const y = e.clientY - containerRect.top - offsetY;
                    
                    node.style.left = `${x}px`;
                    node.style.top = `${y}px`;
                    
                    this.updateConnections();
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });
            }

            selectNode(node) {
                if (this.selectedNode) {
                    this.selectedNode.classList.remove('active');
                }
                
                node.classList.add('active');
                this.selectedNode = node;
            }

            addNode() {
                const id = this.nodeIdCounter++;
                const x = Math.random() * (this.container.clientWidth - 200);
                const y = Math.random() * (this.container.clientHeight - 100);
                
                const node = this.createNode({
                    id,
                    x,
                    y,
                    content: `新节点 ${id}`,
                    color: '#3498db'
                });
                
                this.nodes.push(node);
                this.selectNode(node);
            }

            addChildNode(parentId) {
                const parentNode = this.nodes.find(n => n.dataset.id == parentId);
                if (!parentNode) return;

                const parentRect = parentNode.getBoundingClientRect();
                const containerRect = this.container.getBoundingClientRect();
                
                const id = this.nodeIdCounter++;
                const x = parentRect.left - containerRect.left + 200;
                const y = parentRect.top - containerRect.top + 100;
                
                const node = this.createNode({
                    id,
                    x,
                    y,
                    content: `子节点 ${id}`,
                    color: parentNode.style.borderColor || '#3498db'
                });
                
                this.nodes.push(node);
                this.createConnection(parentId, id);
                this.selectNode(node);
            }

            deleteNode(nodeId) {
                const nodeIndex = this.nodes.findIndex(n => n.dataset.id == nodeId);
                if (nodeIndex === -1) return;

                // 删除所有相关连线
                this.connections = this.connections.filter(conn => 
                    conn.from != nodeId && conn.to != nodeId
                );

                // 删除节点DOM
                const node = this.nodes[nodeIndex];
                node.remove();

                // 从数组中删除
                this.nodes.splice(nodeIndex, 1);
                
                // 更新连线显示
                this.updateConnections();
                
                // 清除选择
                this.selectedNode = null;
            }

            createConnection(fromId, toId) {
                this.connections.push({ from: fromId, to: toId });
                this.updateConnections();
            }

            updateConnections() {
                // 清除旧连线
                document.querySelectorAll('.connection').forEach(el => el.remove());

                // 创建新连线
                this.connections.forEach(conn => {
                    const fromNode = this.nodes.find(n => n.dataset.id == conn.from);
                    const toNode = this.nodes.find(n => n.dataset.id == conn.to);
                    
                    if (!fromNode || !toNode) return;

                    const fromRect = fromNode.getBoundingClientRect();
                    const toRect = toNode.getBoundingClientRect();
                    const containerRect = this.container.getBoundingClientRect();

                    const x1 = fromRect.left - containerRect.left + fromRect.width / 2;
                    const y1 = fromRect.top - containerRect.top + fromRect.height / 2;
                    const x2 = toRect.left - containerRect.left + toRect.width / 2;
                    const y2 = toRect.top - containerRect.top + toRect.height / 2;

                    // 创建SVG连线
                    const svgNS = "http://www.w3.org/2000/svg";
                    const svg = document.createElementNS(svgNS, "svg");
                    svg.className = 'connection';
                    svg.style.width = '100%';
                    svg.style.height = '100%';
                    svg.style.position = 'absolute';
                    svg.style.top = '0';
                    svg.style.left = '0';
                    svg.style.pointerEvents = 'none';

                    const line = document.createElementNS(svgNS, "path");
                    const midX = (x1 + x2) / 2;
                    
                    // 贝塞尔曲线
                    const d = `M ${x1} ${y1} C ${midX} ${y1}, ${midX} ${y2}, ${x2} ${y2}`;
                    line.setAttribute('d', d);
                    line.setAttribute('class', 'connection-line');
                    line.setAttribute('stroke', fromNode.style.borderColor || '#3498db');
                    
                    svg.appendChild(line);
                    this.container.appendChild(svg);
                });
            }

            arrangeTree() {
                // 简单的树形布局算法
                const rootId = 0; // 假设根节点ID为0
                const rootNode = this.nodes.find(n => n.dataset.id == rootId);
                if (!rootNode) return;

                const containerWidth = this.container.clientWidth;
                const containerHeight = this.container.clientHeight;
                
                // 设置根节点位置
                rootNode.style.left = `${containerWidth / 2 - 100}px`;
                rootNode.style.top = `100px`;

                // 简单的子节点排列
                this.nodes.forEach((node, index) => {
                    if (node.dataset.id == rootId) return;
                    
                    const row = Math.floor((index - 1) / 3);
                    const col = (index - 1) % 3;
                    
                    const x = 100 + col * 250;
                    const y = 200 + row * 120;
                    
                    node.style.left = `${x}px`;
                    node.style.top = `${y}px`;
                });

                this.updateConnections();
            }

            changeNodeColor(color) {
                if (!this.selectedNode) return;
                this.selectedNode.style.borderColor = color;
                this.updateConnections();
            }

            exportAsPNG() {
                html2canvas(this.container).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'mindmap.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                });
            }

            setupEventListeners() {
                this.container.addEventListener('click', (e) => {
                    if (e.target === this.container) {
                        if (this.selectedNode) {
                            this.selectedNode.classList.remove('active');
                            this.selectedNode = null;
                        }
                    }
                });
            }

            setupToolbarEvents() {
                // 添加节点
                document.getElementById('addNode').addEventListener('click', () => {
                    this.addNode();
                });

                // 添加子节点
                document.getElementById('addChild').addEventListener('click', () => {
                    if (this.selectedNode) {
                        this.addChildNode(this.selectedNode.dataset.id);
                    }
                });

                // 删除节点
                document.getElementById('deleteNode').addEventListener('click', () => {
                    if (this.selectedNode) {
                        this.deleteNode(this.selectedNode.dataset.id);
                    }
                });

                // 编辑节点
                document.getElementById('editNode').addEventListener('click', () => {
                    if (this.selectedNode) {
                        const contentDiv = this.selectedNode.querySelector('.node-content');
                        contentDiv.contentEditable = true;
                        contentDiv.focus();
                    }
                });

                // 颜色按钮
                document.querySelectorAll('.color-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const color = btn.dataset.color;
                        this.changeNodeColor(color);
                    });
                });

                document.getElementById('changeColor').addEventListener('click', () => {
                    const color = prompt('请输入颜色代码（如 #3498db）：', '#3498db');
                    if (color) {
                        this.changeNodeColor(color);
                    }
                });

                // 自动排列
                document.getElementById('arrangeTree').addEventListener('click', () => {
                    this.arrangeTree();
                });

                // 重置视图
                document.getElementById('resetView').addEventListener('click', () => {
                    this.container.scrollTo({ top: 0, left: 0, behavior: 'smooth' });
                });

                // 导出
                document.getElementById('exportBtn').addEventListener('click', () => {
                    this.exportAsPNG();
                });
            }
        }

        // 页面加载完成后初始化思维导图
        document.addEventListener('DOMContentLoaded', () => {
            window.mindMap = new MindMap('mindmap');
        });
    </script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</body>
</html>
